from bitcoin_usb.address_types import *
import pytest
from unittest.mock import patch
from bitcoin_usb.software_signer import SoftwareSigner

# test seeds
# seed1: spider manual inform reject arch raccoon betray moon document across main build
# seed2: similar seek stock parent depart rug adjust acoustic oppose sell roast hockey
# seed3: debris yellow child maze hen lamp law venue pluck ketchup melody sick


network = bdk.Network.REGTEST


def test_single_sig_spend():
    seed = "spider manual inform reject arch raccoon betray moon document across main build"

    psbt = "cHNidP8BAHECAAAAAX+OrD5rcUUUsYNLBWdcJjYG8TD9cfqttrEuG2Xj8PFgAAAAAAD9////AvNJXQUAAAAAFgAU9RChTmc3g0aRPVXDW3Pn+4BpcnyAlpgAAAAAABYAFCre0yWobi1cdShVshiOIFBiJzTDdgAAAE8BBDWHzwMyFoPCgAAAAJGLoVloEn3xJ2mtPtKTWFKeElFncZVq25u2pPBXiYyJA7ghwtM8sm2iyDZJuQsPpkPzv/Mz7WoCeW8ySg/cJZw4EHyF8rVUAACAAQAAgAAAAIAAAQBxAgAAAAHzye6Jjq/OfTShvE1mK4mPHq46TnLWXXl/Dst7HVD2CgAAAAAA/f///wIA4fUFAAAAABYAFI6GwbSN5egsC6wjpye0G9z6emxhcxAQJAEAAAAWABSdDWCaRKCzjBdtdrhQmWCAuiY/CAAAAAABAR8A4fUFAAAAABYAFI6GwbSN5egsC6wjpye0G9z6emxhAQMEAQAAACIGAmwUkzrL/GENve6WmL8kg0lNdhSHdIKe4dJjuO281HCZGHyF8rVUAACAAQAAgAAAAIAAAAAAAAAAAAAiAgNdIY795pswZFA83q0cM9XbgmXl8MU29aseHqtv7+wGzBh8hfK1VAAAgAEAAIAAAACAAQAAAAAAAAAAIgIDJE38dFQK12Q+UlcjOn+X/fHGcm84ablxHKI56Qr6t+0YfIXytVQAAIABAACAAAAAgAAAAAABAAAAAA=="

    software_signer = SoftwareSigner(seed, network)
    signed_psbt = software_signer.sign_psbt(bdk.PartiallySignedTransaction(psbt))

    assert (
        signed_psbt.serialize()
        == "cHNidP8BAHECAAAAAX+OrD5rcUUUsYNLBWdcJjYG8TD9cfqttrEuG2Xj8PFgAAAAAAD9////AvNJXQUAAAAAFgAU9RChTmc3g0aRPVXDW3Pn+4BpcnyAlpgAAAAAABYAFCre0yWobi1cdShVshiOIFBiJzTDdgAAAE8BBDWHzwMyFoPCgAAAAJGLoVloEn3xJ2mtPtKTWFKeElFncZVq25u2pPBXiYyJA7ghwtM8sm2iyDZJuQsPpkPzv/Mz7WoCeW8ySg/cJZw4EHyF8rVUAACAAQAAgAAAAIAAAQBxAgAAAAHzye6Jjq/OfTShvE1mK4mPHq46TnLWXXl/Dst7HVD2CgAAAAAA/f///wIA4fUFAAAAABYAFI6GwbSN5egsC6wjpye0G9z6emxhcxAQJAEAAAAWABSdDWCaRKCzjBdtdrhQmWCAuiY/CAAAAAABAR8A4fUFAAAAABYAFI6GwbSN5egsC6wjpye0G9z6emxhAQhrAkcwRAIgbZS9PecHX4GhPQCdcYv4mbXkuKmypAlQSDCDmY8k0AECIGA3WVj1VfZF2xSdMJnFO/CUXMOyfqG2tvlNMZoRVusjASECbBSTOsv8YQ297paYvySDSU12FId0gp7h0mO47bzUcJkAIgIDXSGO/eabMGRQPN6tHDPV24Jl5fDFNvWrHh6rb+/sBswYfIXytVQAAIABAACAAAAAgAEAAAAAAAAAACICAyRN/HRUCtdkPlJXIzp/l/3xxnJvOGm5cRyiOekK+rftGHyF8rVUAACAAQAAgAAAAIAAAAAAAQAAAAA="
    )
    logger.info(signed_psbt.serialize())


def test_single_multisig_sign():
    seed = "spider manual inform reject arch raccoon betray moon document across main build"

    psbt = "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"

    software_signer = SoftwareSigner(seed, network)
    signed_psbt = software_signer.sign_psbt(bdk.PartiallySignedTransaction(psbt))

    assert (
        signed_psbt.serialize()
        == "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"
    )
    logger.info(signed_psbt.serialize())
